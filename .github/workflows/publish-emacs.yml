name: Publish Emacs to WinGet
on:
  workflow_dispatch:
jobs:
  publish:
    runs-on: windows-latest
    steps:
      - name: Get latest Emacs version and download installer
        id: get_version
        shell: pwsh
        run: |
          $page = Invoke-WebRequest -Uri "https://ftp.gnu.org/gnu/emacs/windows/"
          $latest_major = $page.Links | Where-Object { $_.href -match 'emacs-\d+/$' } | ForEach-Object { $_.href.TrimEnd('/') } | Sort-Object -Descending | Select-Object -First 1
          $installer_page = Invoke-WebRequest -Uri "https://ftp.gnu.org/gnu/emacs/windows/$latest_major/"
          $latest_installer_name = $installer_page.Links | Where-Object { $_.href -match 'emacs-.*-installer.exe$' } | ForEach-Object { $_.href } | Sort-Object -Descending | Select-Object -First 1
          $url = "https://ftp.gnu.org/gnu/emacs/windows/$latest_major/$latest_installer_name"
          $version = ($latest_installer_name -split '-')[-2]
          echo "URL=$url" >> $env:GITHUB_ENV
          echo "VERSION=$version" >> $env:GITHUB_ENV
          echo "INSTALLER_NAME=$latest_installer_name" >> $env:GITHUB_ENV
          echo "Complete URL: $url"
          curl.exe -L "$url" -o "$latest_installer_name"

      - name: Calculate Installer Hash
        id: calculate_hash
        shell: pwsh
        run: |
          $hash = (Get-FileHash -Path "${{ env.INSTALLER_NAME }}" -Algorithm SHA256).Hash
          echo "INSTALLER_HASH=$hash" >> $env:GITHUB_ENV
          echo "Installer SHA256 Hash: $hash"

      - name: Install winget-create
        run: dotnet tool install -g Microsoft.Winget.Create

      - name: Create winget manifest
        run: wingetcreate.exe update GNU.Emacs --urls ${{ env.URL }} --version ${{ env.VERSION }} --installer-sha256 ${{ env.INSTALLER_HASH }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update GNU.Emacs to ${{ env.VERSION }}"
          title: "[New Package] GNU.Emacs ${{ env.VERSION }}"
          body: "This PR updates GNU.Emacs to version ${{ env.VERSION }}."
          branch: "update-emacs-${{ env.VERSION }}"
          base: "master"
          path: "manifests/g/GNU/Emacs"
          repo: "microsoft/winget-pkgs"
          fork: "${{ github.actor }}/winget-pkgs"
